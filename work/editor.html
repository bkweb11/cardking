<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric.js Photo Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
            padding: 20px;
        }
        #editor {
            width: 1100px;
            height: 700px;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }
        #canvas-container {
            flex: 1;
            margin-right: 20px;
            border: 1px solid #ddd;
        }
        canvas {
            border: 1px solid #000;
            display: block;
        }
        #controls {
            width: 250px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        #controls button, #controls input[type="file"], #controls select {
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-size: 14px;
        }
        .icon-btn {
            font-size: 20px;
        }
        .btn-group {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn-group button {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .layer-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 5px;
            background-color: #fff;
            border-radius: 3px;
            cursor: pointer;
        }
        .layer-item.selected {
            background-color: #e0e0e0;
        }
        .layer-item button {
            background-color: transparent;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="editor">
    <!-- Canvas for editing -->
    <div id="canvas-container">
        <canvas id="canvas" width="800" height="500"></canvas>
    </div>

    <!-- Controls for image and text editing -->
    <div id="controls">
        <div class="btn-group">
            <button id="addTextBtn" class="icon-btn"><i class="fas fa-font"></i></button>
            <button id="addRectangleBtn" class="icon-btn"><i class="fas fa-square"></i></button>
            <button id="addCircleBtn" class="icon-btn"><i class="fas fa-circle"></i></button>
        </div>
        
        <input type="file" id="imageLoaderBtn" accept="image/*" />
        
        <input type="color" id="color-picker" value="#FF0000">
        
        <select id="font-family">
            <option value="Arial">Arial</option>
            <option value="Courier New">Courier New</option>
            <option value="Georgia">Georgia</option>
            <option value="Times New Roman">Times New Roman</option>
        </select>
        
        <input type="number" id="font-size" value="30" min="10" max="100">
        
        <input type="color" id="background-color" value="#ffffff">

        <div class="btn-group">
            <button id="bringToFront" class="icon-btn"><i class="fas fa-arrow-up"></i></button>
            <button id="sendToBack" class="icon-btn"><i class="fas fa-arrow-down"></i></button>
            <button id="deleteObject" class="icon-btn"><i class="fas fa-trash-alt"></i></button>
        </div>

        <button id="saveBtn" style="margin-top: 20px; background-color: #4CAF50; color: white;"><i class="fas fa-download"></i> Save Image</button>

        <!-- Layer List -->
        <div class="layer-list" id="layerList"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script>
    const canvas = new fabric.Canvas('canvas');
    canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));

    let layerCount = 1; // For counting layers (1, 2, 3, etc.)
    let objectIdToLayer = {}; // Map to link object IDs to their layers

    // Function to add text
    function addText() {
        const text = new fabric.IText('Hello, World!', {
            left: 150,
            top: 150,
            fontFamily: 'Arial',
            fill: '#FF0000',
            fontSize: 30
        });
        canvas.add(text);
        updateLayerList(text);
        canvas.setActiveObject(text);
        canvas.renderAll();
    }

    // Function to add rectangle
    function addRectangle() {
        const rectangle = new fabric.Rect({
            left: 200,
            top: 200,
            fill: 'blue',
            width: 100,
            height: 100,
            selectable: true
        });
        canvas.add(rectangle);
        updateLayerList(rectangle);
        canvas.setActiveObject(rectangle);
        canvas.renderAll();
    }

    // Function to add circle
    function addCircle() {
        const circle = new fabric.Circle({
            left: 300,
            top: 300,
            radius: 50,
            fill: 'green',
            selectable: true
        });
        canvas.add(circle);
        updateLayerList(circle);
        canvas.setActiveObject(circle);
        canvas.renderAll();
    }

    // Load image to canvas
    document.getElementById('imageLoaderBtn').addEventListener('change', function(event) {
        const reader = new FileReader();
        reader.onload = function(e) {
            fabric.Image.fromURL(e.target.result, function(img) {
                img.set({
                    left: 100,
                    top: 100,
                    scaleX: 0.5,
                    scaleY: 0.5
                });
                canvas.add(img);
                updateLayerList(img);
                canvas.renderAll();
            });
        };
        reader.readAsDataURL(event.target.files[0]);
    });

    // Update the layer list UI
    function updateLayerList(obj) {
        const layerList = document.getElementById('layerList');
        const layerItem = document.createElement('div');
        layerItem.classList.add('layer-item');
        layerItem.dataset.objectId = obj.id;

        // Layer name and icon based on object type
        let label = `Layer ${layerCount++}`;
        let icon = '';
        if (obj instanceof fabric.IText) {
            label = `Text ${label}`;
            icon = '<i class="fas fa-font"></i>';
        } else if (obj instanceof fabric.Image) {
            label = `Image ${label}`;
            icon = '<i class="fas fa-image"></i>';
        } else if (obj instanceof fabric.Rect) {
            label = `Rectangle ${label}`;
            icon = '<i class="fas fa-square"></i>';
        } else if (obj instanceof fabric.Circle) {
            label = `Circle ${label}`;
            icon = '<i class="fas fa-circle"></i>';
        }

        layerItem.innerHTML = `
            <span>${icon} ${label}</span>
            <button class="eye-btn"><i class="fas fa-eye"></i></button>
            <button class="color-btn"><i class="fas fa-paint-brush"></i></button>
        `;

        // Store reference to the layer object
        objectIdToLayer[obj.id] = layerItem;

        // Select object on layer click
        layerItem.addEventListener('click', function() {
            canvas.setActiveObject(obj);
            document.querySelectorAll('.layer-item').forEach(item => item.classList.remove('selected'));
            layerItem.classList.add('selected');
        });

        layerList.appendChild(layerItem);
    }

    // Listen for object selection and update layer selection
    canvas.on('object:selected', function(e) {
        const selectedObject = e.target;
        if (selectedObject) {
            const selectedLayer = objectIdToLayer[selectedObject.id];
            if (selectedLayer) {
                document.querySelectorAll('.layer-item').forEach(item => item.classList.remove('selected'));
                selectedLayer.classList.add('selected');
            }
        }
    });

    // Event listener for changing font color
    document.getElementById('color-picker').addEventListener('input', function() {
        const color = this.value;
        const activeObject = canvas.getActiveObject();
        if (activeObject instanceof fabric.IText) {
            activeObject.set({ fill: color });
            canvas.renderAll();
        } else if (activeObject instanceof fabric.Rect || activeObject instanceof fabric.Circle) {
            activeObject.set({ fill: color });
            canvas.renderAll();
        }
    });

    // Event listener for font size change
    document.getElementById('font-size').addEventListener('input', function() {
        const fontSize = parseInt(this.value);
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject instanceof fabric.IText) {
            activeObject.set({ fontSize });
            canvas.renderAll();
        }
    });

    // Event listener for font family change
    document.getElementById('font-family').addEventListener('change', function() {
        const fontFamily = this.value;
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject instanceof fabric.IText) {
            activeObject.set({ fontFamily });
            canvas.renderAll();
        }
    });

    // Event listeners for bring to front / send to back actions
    document.getElementById('bringToFront').addEventListener('click', function() {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            activeObject.bringForward();
            canvas.renderAll();
        }
    });

    document.getElementById('sendToBack').addEventListener('click', function() {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            activeObject.sendBackwards();
            canvas.renderAll();
        }
    });

    // Event listener for deleting an object
    document.getElementById('deleteObject').addEventListener('click', function() {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            canvas.remove(activeObject);
            const layerItem = document.querySelector(`[data-object-id="${activeObject.id}"]`);
            if (layerItem) {
                layerItem.remove();
            }
            canvas.renderAll();
        }
    });

    // Event listener for saving canvas as an image
    document.getElementById('saveBtn').addEventListener('click', function() {
        const dataUrl = canvas.toDataURL({ format: 'png' });
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'canvas-image.png';
        link.click();
    });

    // Event listeners for adding elements to canvas
    document.getElementById('addTextBtn').addEventListener('click', addText);
    document.getElementById('addRectangleBtn').addEventListener('click', addRectangle);
    document.getElementById('addCircleBtn').addEventListener('click', addCircle);
</script>

</body>
</html>
